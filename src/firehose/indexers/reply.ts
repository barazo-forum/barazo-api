import { eq, sql } from 'drizzle-orm'
import { replies } from '../../db/schema/replies.js'
import { topics } from '../../db/schema/topics.js'
import type { Database } from '../../db/index.js'
import type { Logger } from '../../lib/logger.js'
import type { TrustStatus } from '../../services/account-age.js'
import { clampCreatedAt } from '../clamp-timestamp.js'
import { sanitizeHtml } from '../../lib/sanitize.js'

interface CreateParams {
  uri: string
  rkey: string
  did: string
  cid: string
  record: Record<string, unknown>
  live: boolean
  trustStatus: TrustStatus
}

interface UpdateParams {
  uri: string
  rkey: string
  did: string
  cid: string
  record: Record<string, unknown>
  live: boolean
  trustStatus: TrustStatus
}

interface DeleteParams {
  uri: string
  rkey: string
  did: string
  rootUri: string
}

export class ReplyIndexer {
  constructor(
    private db: Database,
    private logger: Logger
  ) {}

  async handleCreate(params: CreateParams): Promise<void> {
    const { uri, rkey, did, cid, record, live, trustStatus } = params

    const root = record['root'] as { uri: string; cid: string }
    const parent = record['parent'] as { uri: string; cid: string }
    const clientCreatedAt = new Date(record['createdAt'] as string)
    const createdAt = live ? clampCreatedAt(clientCreatedAt) : clientCreatedAt

    await this.db.transaction(async (tx) => {
      await tx
        .insert(replies)
        .values({
          uri,
          rkey,
          authorDid: did,
          content: sanitizeHtml(record['content'] as string),
          contentFormat: (record['contentFormat'] as string | undefined) ?? null,
          rootUri: root.uri,
          rootCid: root.cid,
          parentUri: parent.uri,
          parentCid: parent.cid,
          communityDid: record['community'] as string,
          cid,
          labels: (record['labels'] as { values: { val: string }[] } | undefined) ?? null,
          createdAt,
          trustStatus,
        })
        .onConflictDoNothing()

      // Increment reply count and update last activity
      await tx
        .update(topics)
        .set({
          replyCount: sql`${topics.replyCount} + 1`,
          lastActivityAt: new Date(),
        })
        .where(eq(topics.uri, root.uri))
    })

    this.logger.debug({ uri, did, trustStatus }, 'Indexed reply')
  }

  async handleUpdate(params: UpdateParams): Promise<void> {
    const { uri, cid, record } = params

    await this.db
      .update(replies)
      .set({
        content: sanitizeHtml(record['content'] as string),
        contentFormat: (record['contentFormat'] as string | undefined) ?? null,
        cid,
        labels: (record['labels'] as { values: { val: string }[] } | undefined) ?? null,
        indexedAt: new Date(),
      })
      .where(eq(replies.uri, uri))

    this.logger.debug({ uri }, 'Updated reply')
  }

  async handleDelete(params: DeleteParams): Promise<void> {
    const { uri, rootUri } = params

    await this.db.transaction(async (tx) => {
      await tx.update(replies).set({ isAuthorDeleted: true }).where(eq(replies.uri, uri))

      // Decrement reply count (floor at 0 via GREATEST)
      if (rootUri) {
        await tx
          .update(topics)
          .set({
            replyCount: sql`GREATEST(${topics.replyCount} - 1, 0)`,
          })
          .where(eq(topics.uri, rootUri))
      }
    })

    this.logger.debug({ uri }, 'Soft-deleted reply (author delete)')
  }
}
